<!DOCTYPE html>
<html lang="en">

<head>
    <link href='https://fonts.googleapis.com/css?family=PT+Serif' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
    <meta charset="UTF-8">
    <title>CO2 Emissions</title>
    <style type="text/css">

    </style>
    <script type="text/javascript" src="https://d3js.org/d3.v4.0.0-alpha.35.min.js"></script>
</head>

<body>
    <div id="container">


        <div class="btn-group" data-toggle="buttons-radio">
            <button type="button" class="button1" value="totalEmission">Total Emissions</button>
            <button type="button" class="button1" value="emissionPerCap">Per Capita Emissions</button>
        </div>
        <div class="btn-group2" data-toggle="buttons-radio">
            <button type="button" class="button2" value="scaleLinear">Linear Scale</button>
            <button type="button" class="button2" value="scaleLog">Log Scale</button>
        </div>
        <div id="bub"></div>
        <div id="svganchor"></div>
        <div id="checkboxes">
            <span>Click to hide/show:&nbsp;&nbsp;</span>
            <label><input type="checkbox" name="continent" value="africa" checked>Africa
                <span id="africaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span></label>
            <label><input type="checkbox" name="continent" value="northAmerica" checked>North America
                <span id="namericaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span></label>
            <label><input type="checkbox" name="continent" value="southAmerica" checked>South America
                <span id="samericaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span></label>
            <label><input type="checkbox" name="continent" value="asia" checked>Asia
                <span id="asiaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span></label>
            <label><input type="checkbox" name="continent" value="europe" checked>Europe
                <span id="europeColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span></label>
            <label><input type="checkbox" name="continent" value="oceania" checked>Oceania
                <span id="oceaniaColor" style="font-size:20px;">&bull;&nbsp;&nbsp;</span></label>
        </div>

    </div>
    <script type="text/javascript">

        // force
        // const width = 1000
        // const height = 600
        // const svg2 = d3.select("#bub").append("svg")
        //     .attr("width", width)
        //     .attr("height", height)

        // const roleScale = d3.scaleOrdinal()
        //     .range(['coral', 'olive', 'skyblue', 'pink']);

        // let sampleData = d3.range(196).map((d, i) => ({ r: 40 - i * 0.5 }))

        // // set params for force layout
        // const manyBody = d3.forceManyBody().strength(2)
        // const center = d3.forceCenter().x((width / 2)).y((height / 2))

        // // define force
        // let force = d3.forceSimulation()
        //     .force('charge', manyBody)
        //     .force('center', center)
        //     .force('collision', d3.forceCollide(d => 20))
        //     .nodes(sampleData)
        //     .on('tick', changeNetwork)

        // svg2.selectAll('circle')
        //     .data(sampleData)
        //     .enter()
        //     .append('circle')
        //     .style('fill', (d, i) => roleScale(i))
        //     .attr('r', d => d.r)

        // function changeNetwork() {
        //     d3.selectAll('circle')
        //         .attr('cx', d => d.x)
        //         .attr('cy', d => d.y)
        // }


        /// end


        // set width/height
        const WIDTH = 1000;
        const HEIGHT = 480;
        // define margin
        const MARGIN = { TOP: 0, RIGHT: 40, BOTTOM: 34, LEFT: 50 };

        let xScale = d3.scaleLinear()
            .range([MARGIN.LEFT, WIDTH - MARGIN.RIGHT]);

        let xAxis = d3.axisBottom(xScale)
            .ticks(10, ".0s")
            .tickSizeOuter(0);

        let emScale = d3.scaleLinear()
            .range([5, 30]);

        let colors = d3.scaleOrdinal()
            .domain(["asia", "africa", "northAmerica", "europe", "southAmerica", "oceania"])
            .range(['pink', 'teal', 'skyblue', 'coral', 'grey', 'tan']);

        d3.select("#africaColor").style("color", colors("africa"));
        d3.select("#namericaColor").style("color", colors("northAmerica"));
        d3.select("#samericaColor").style("color", colors("southAmerica"));
        d3.select("#asiaColor").style("color", colors("asia"));
        d3.select("#europeColor").style("color", colors("europe"));
        d3.select("#oceaniaColor").style("color", colors("oceania"));

        let formatNumber = d3.format(",");

        let tt = d3.select("#svganchor").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        let svg = d3.select("#svganchor")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT);

        let xline = svg.append("line")
            .attr("stroke", "gray")
            .attr("stroke-dasharray", "1,2");

        let chartState = {};

        chartState.variable = "totalEmission";
        chartState.scale = "scaleLinear";
        chartState.legend = "Total emissions, in kilotonnes";

        d3.csv("co2bee.csv", function (error, data) {
            if (error) throw error;

            let dataSet = data;

            emScale.domain(d3.extent(data, d => +d.emissionPerCap));

            xScale.domain(d3.extent(data, d => +d.totalEmission));

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (HEIGHT - MARGIN.BOTTOM) + ")")
                .call(xAxis);

            var legend = svg.append("text")
                .attr("text-anchor", "middle")
                .attr("x", WIDTH / 2)
                .attr("y", HEIGHT - 4)
                .attr("font-family", "PT Sans")
                .attr("font-size", 12)
                .attr("fill", "darkslategray")
                .attr("fill-opacity", 1)
                .attr("class", "legend");


            const manyBody = d3.forceManyBody().strength(2)
            const center = d3.forceCenter().x((WIDTH / 2)).y((HEIGHT / 2))
            // define force
            var simulation = d3.forceSimulation(dataSet)
                .force('center', center)
                .force('collision', d3.forceCollide(d => emScale(d.emissionPerCap)))

            for (var i = 0; i < dataSet.length; ++i) {
                simulation.tick();
            }

            // define circles
            var countriesCircles = svg.selectAll(".countries")
                .data(dataSet, d => d.countryCode);

            countriesCircles.exit()
                .transition()
                .duration(1000)
                .attr("cx", 0)
                .attr("cy", (HEIGHT / 2) - MARGIN.BOTTOM / 2)
                .remove();

            countriesCircles.enter()
                .append("circle")
                .attr("class", "countries")
                .attr("cx", 0)
                .attr("cy", (HEIGHT / 2) - MARGIN.BOTTOM / 2)
                .attr("r", d => emScale(d.emissionPerCap))
                .style('stroke', 'black')
                .style('stroke-width', 0)
                .attr('fill-opacity', .85)
                .attr("fill", d => colors(d.continent))
                .merge(countriesCircles)
                .transition()
                .duration(1500)
                .ease(d3.easeBack)
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
            console.log('yep')


            // redraw(chartState.variable);

            d3.selectAll(".button1").on("click", function () {
                var thisClicked = this.value;
                chartState.variable = thisClicked;
                if (thisClicked == "totalEmission") {
                    chartState.legend = "Total emissions, in kilotonnes";
                };
                if (thisClicked == "emissionPerCap") {
                    chartState.legend = "Per Capita emissions, in metric tons";
                }
                redraw(chartState.variable);
            });

            d3.selectAll(".button2").on("click", function () {
                var thisClicked = this.value;
                chartState.scale = thisClicked;
                redraw(chartState.variable);
            });

            d3.selectAll("input").on("change", filter);

            function redraw(variable) {

                if (chartState.scale == "scaleLinear") { xScale = d3.scaleLinear().range([MARGIN.LEFT, WIDTH - MARGIN.RIGHT]); };

                if (chartState.scale == "scaleLog") { xScale = d3.scaleLog().range([MARGIN.LEFT, WIDTH - MARGIN.RIGHT]); };

                xScale.domain(d3.extent(dataSet, d => +d[variable]));

                var xAxis = d3.axisBottom(xScale)
                    .ticks(10, ".0s")
                    .tickSizeOuter(0);

                d3.transition(svg).select(".x.axis").transition().duration(1000)
                    .call(xAxis);

                // define simulation
                var simulation = d3.forceSimulation(dataSet)
                    .force("x", d3.forceX(d => xScale(+d[variable])).strength(2))
                    .force("y", d3.forceY((HEIGHT / 2) - MARGIN.BOTTOM / 2))
                    .force("collide", d3.forceCollide(d => emScale(d.emissionPerCap)))
                    .stop();

                // only tick once
                for (var i = 0; i < dataSet.length; ++i) simulation.tick();

                // define circles
                var countriesCircles = svg.selectAll(".countries")
                    .data(dataSet, d => d.countryCode);

                countriesCircles.exit()
                    .transition()
                    .duration(1000)
                    .attr("cx", 0)
                    .attr("cy", (HEIGHT / 2) - MARGIN.BOTTOM / 2)
                    .remove();

                countriesCircles.enter()
                    // .append('g')
                    // .classed('dot', true)
                    .append("circle")
                    .attr("class", "countries")
                    .attr("cx", 0)
                    .attr("cy", (HEIGHT / 2) - MARGIN.BOTTOM / 2)
                    .attr("r", 7)
                    .style('stroke', 'black')
                    .attr('fill-opacity', .75)
                    .attr("fill", d => colors(d.continent))
                    .merge(countriesCircles)
                    .transition()
                    .duration(1500)
                    .ease(d3.easeBack)
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                legend.text(chartState.legend);

                d3.selectAll(".countries").on("mousemove", function (d) {
                    tt.html("Country: <strong>" + d.countryName + "</strong><br>"
                        + chartState.legend.slice(0, chartState.legend.indexOf(",")) + ": <strong>" + formatNumber(d[variable]) + "</strong>" + chartState.legend.slice(chartState.legend.lastIndexOf(" ")))
                        .style('top', d3.event.pageY - 12 + 'px')
                        .style('left', d3.event.pageX + 25 + 'px')
                        .style("opacity", 0.9);

                    xline.attr("x1", d3.select(this).attr("cx"))
                        .attr("y1", d3.select(this).attr("cy"))
                        .attr("y2", (HEIGHT - MARGIN.BOTTOM))
                        .attr("x2", d3.select(this).attr("cx"))
                        .attr("opacity", 1);

                }).on("mouseout", (d) => {
                    tt.style("opacity", 0);
                    xline.attr("opacity", 0);
                });

                d3.selectAll(".x.axis, .legend").on("mousemove", function () {
                    tt.html("This axis uses SI prefixes:<br>m: 10<sup>-3</sup><br>k: 10<sup>3</sup><br>M: 10<sup>6</sup>")
                        .style('top', d3.event.pageY - 12 + 'px')
                        .style('left', d3.event.pageX + 25 + 'px')
                        .style("opacity", 0.9);
                }).on("mouseout", d => tt.style("opacity", 0));

                //end of redraw
            }

            function filter() {

                function getCheckedBoxes(chkboxName) {
                    var checkboxes = document.getElementsByName(chkboxName);
                    var checkboxesChecked = [];
                    for (var i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            checkboxesChecked.push(checkboxes[i].defaultValue);
                        }
                    }
                    return checkboxesChecked.length > 0 ? checkboxesChecked : null;
                }

                var checkedBoxes = getCheckedBoxes("continent");

                var newData = [];

                if (checkedBoxes == null) {
                    dataSet = newData;
                    redraw();
                    return;
                };

                for (var i = 0; i < checkedBoxes.length; i++) {
                    var newArray = data.filter(function (d) {
                        return d.continent == checkedBoxes[i];
                    });
                    Array.prototype.push.apply(newData, newArray);
                }

                dataSet = newData;

                redraw(chartState.variable);

                //end of filter
            }

            //end of d3.csv
        });

    </script>
</body>

</html>